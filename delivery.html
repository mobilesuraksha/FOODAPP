<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIKA Rider</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; background-color: #0f172a; color: #f8fafc; padding-bottom: 100px; user-select: none; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }
        .card-gradient { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); }
        .status-badge { padding: 4px 10px; border-radius: 6px; font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
        .st-new { background: #ea580c; color: white; animation: pulse 2s infinite; }
        .st-active { background: #3b82f6; color: white; }
        .slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .toggle-checkbox:checked { right: 0; border-color: #22c55e; }
        .toggle-checkbox:checked + .toggle-label { background-color: #22c55e; }
        .toggle-checkbox { right: auto; left: 0; }
        .toggle-label { width: 3rem; height: 1.5rem; }
        .toggle-checkbox { width: 1.5rem; height: 1.5rem; }
    </style>
</head>
<body class="select-none">

    <div id="installBanner" class="hidden fixed top-0 w-full bg-orange-600 text-white px-4 py-3 flex justify-between items-center z-[100] shadow-xl">
        <div class="flex items-center gap-3">
            <div class="bg-white/20 w-8 h-8 rounded-lg flex items-center justify-center"><i class="fas fa-download"></i></div>
            <div><p class="text-xs font-bold">Install Rider App</p><p class="text-[10px] opacity-80">Required for GPS Tracking</p></div>
        </div>
        <button id="installBtn" class="bg-black/30 px-4 py-1.5 rounded-lg text-xs font-black border border-white/10">INSTALL</button>
    </div>

    <div id="login" class="fixed inset-0 bg-[#0f172a] z-[100] flex items-center justify-center p-6">
        <div class="w-full max-w-sm text-center relative">
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-48 h-48 bg-blue-500/20 rounded-full blur-[60px]"></div>
            <div class="relative z-10">
                <div class="w-24 h-24 bg-gradient-to-tr from-orange-500 to-red-600 rounded-[2rem] flex items-center justify-center mx-auto mb-6 text-5xl shadow-2xl shadow-orange-500/20 text-white app-logo">V</div>
                <h2 class="text-4xl font-black mb-1 tracking-tighter app-name">VIKA</h2>
                <p class="text-slate-400 text-sm mb-10 font-bold uppercase tracking-widest">Delivery Partner</p>
                <div class="space-y-4">
                    <input id="lPhone" type="number" placeholder="Mobile Number" class="w-full bg-slate-800 p-4 rounded-2xl text-white font-bold outline-none border border-slate-700 focus:border-orange-500 transition placeholder-slate-500">
                    <input id="lPass" type="password" placeholder="Password" class="w-full bg-slate-800 p-4 rounded-2xl text-white font-bold outline-none border border-slate-700 focus:border-orange-500 transition placeholder-slate-500">
                    <button id="loginBtn" class="w-full bg-white text-slate-900 py-4 rounded-2xl font-black shadow-xl hover:scale-[1.02] transition">START DUTY</button>
                </div>
            </div>
        </div>
    </div>

    <div id="mainApp" class="hidden min-h-screen">
        <header class="fixed top-0 w-full bg-[#0f172a]/95 backdrop-blur z-40 px-5 py-4 flex justify-between items-center border-b border-white/5 pt-4">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-slate-800 border border-slate-700 flex items-center justify-center text-lg shadow-inner">ðŸ‘·</div>
                <div>
                    <h1 class="font-black text-lg leading-none text-white" id="rName">Rider</h1>
                    <div class="flex items-center gap-2 mt-1">
                        <span id="statusDot" class="w-2 h-2 bg-red-500 rounded-full"></span>
                        <span id="statusText" class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Offline</span>
                    </div>
                </div>
            </div>
            <div class="relative inline-block w-12 align-middle select-none transition duration-200 ease-in">
                <input type="checkbox" name="toggle" id="dutyToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300"/>
                <label for="dutyToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-700 cursor-pointer transition-colors duration-300"></label>
            </div>
        </header>

        <div id="view-home" class="pt-24 px-4 pb-24 fade-in">
            <div class="glass-panel p-6 rounded-[2rem] mb-8 relative overflow-hidden shadow-2xl">
                <div class="absolute -right-6 -top-6 w-32 h-32 bg-green-500/10 rounded-full blur-2xl"></div>
                <div class="grid grid-cols-2 gap-6 relative z-10">
                    <div>
                        <p class="text-xs text-slate-400 font-bold uppercase tracking-widest mb-1">Today's Earnings</p>
                        <h2 class="text-4xl font-black text-white">â‚¹<span id="todayEarn">0</span></h2>
                    </div>
                    <div class="text-right border-l border-white/10 pl-4">
                        <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Orders</p>
                        <h2 class="text-2xl font-black text-white mb-2" id="todayCount">0</h2>
                        <div class="bg-orange-500/20 text-orange-400 text-[10px] font-bold px-2 py-1 rounded inline-block">COD: â‚¹<span id="codHand">0</span></div>
                    </div>
                </div>
            </div>

            <div class="flex justify-between items-center mb-4">
                <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest"><i class="fas fa-bolt text-yellow-400 mr-2"></i> Current Tasks</h3>
                <button onclick="document.getElementById('sosModal').classList.remove('hidden')" class="text-red-500 text-xs font-bold border border-red-500/30 px-3 py-1 rounded-full hover:bg-red-500/10 transition">SOS</button>
            </div>
            
            <div id="taskList" class="space-y-4">
                <div class="text-center py-20 opacity-30">
                    <i class="fas fa-power-off text-4xl mb-4"></i>
                    <p class="font-bold text-sm">You are Offline</p>
                    <p class="text-[10px] mt-1">Go Online to receive orders</p>
                </div>
            </div>
        </div>

        <div id="view-hist" class="hidden pt-24 px-4 pb-24 fade-in">
            <h2 class="text-2xl font-black mb-6 text-white">Completed Jobs</h2>
            <div id="histList" class="space-y-3"></div>
        </div>

        <div id="view-prof" class="hidden pt-24 px-4 pb-24 fade-in">
            <div class="text-center mb-10 mt-10">
                <div class="w-28 h-28 bg-gradient-to-br from-slate-700 to-slate-800 rounded-full mx-auto flex items-center justify-center text-5xl mb-6 border-4 border-slate-700 shadow-2xl">ðŸ˜Ž</div>
                <h2 class="text-3xl font-black text-white mb-1" id="pName">Rider Name</h2>
                <p class="text-slate-400 font-bold text-sm" id="pPhone">+91 XXXXX XXXXX</p>
            </div>
            <div class="space-y-3">
                <div class="glass-panel p-5 rounded-2xl flex justify-between items-center">
                    <span class="font-bold text-sm text-slate-300">Lifetime Orders</span>
                    <span class="font-black text-xl text-white" id="pTotal">0</span>
                </div>
                <div class="glass-panel p-5 rounded-2xl flex justify-between items-center">
                    <span class="font-bold text-sm text-slate-300">Total Earnings</span>
                    <span class="font-black text-xl text-green-400">â‚¹<span id="pEarn">0</span></span>
                </div>
            </div>
            <button onclick="location.reload()" class="w-full bg-red-500/10 text-red-500 border border-red-500/20 py-4 rounded-xl font-bold mt-12 hover:bg-red-500/20 transition flex items-center justify-center gap-2">
                <i class="fas fa-sign-out-alt"></i> LOGOUT
            </button>
        </div>

        <div class="fixed bottom-0 w-full bg-[#0f172a] border-t border-slate-800 flex justify-around pb-6 pt-4 z-50 shadow-2xl">
            <button onclick="nav('home')" id="btn-home" class="text-white flex flex-col items-center gap-1 opacity-100 transition"><i class="fas fa-map-marker-alt text-xl"></i><span class="text-[10px] font-bold">Tasks</span></button>
            <button onclick="nav('hist')" id="btn-hist" class="text-slate-500 flex flex-col items-center gap-1 hover:text-white transition"><i class="fas fa-history text-xl"></i><span class="text-[10px] font-bold">History</span></button>
            <button onclick="nav('prof')" id="btn-prof" class="text-slate-500 flex flex-col items-center gap-1 hover:text-white transition"><i class="fas fa-user text-xl"></i><span class="text-[10px] font-bold">Profile</span></button>
        </div>
    </div>

    <div id="orderModal" class="fixed inset-0 bg-black/95 z-[80] hidden flex items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-slate-900 w-full max-w-md rounded-t-[2rem] sm:rounded-[2rem] p-6 slide-up border-t border-slate-700 h-[85vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black text-white">Order Details</h2>
                <button onclick="document.getElementById('orderModal').classList.add('hidden')" class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center text-white"><i class="fas fa-times"></i></button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <div id="sosModal" class="fixed inset-0 bg-black/95 z-[100] hidden flex items-center justify-center p-6 backdrop-blur-md">
        <div class="w-full max-w-sm bg-slate-900 p-8 rounded-[2rem] border border-red-500/30 text-center relative">
            <button onclick="document.getElementById('sosModal').classList.add('hidden')" class="absolute top-4 right-4 text-slate-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            <div class="w-20 h-20 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-6 text-red-500 text-4xl animate-pulse"><i class="fas fa-exclamation-triangle"></i></div>
            <h2 class="text-3xl font-black text-white mb-2">Emergency</h2>
            <div class="space-y-3 mt-6">
                <a href="tel:100" class="flex items-center gap-4 bg-slate-800 p-4 rounded-xl border border-slate-700 hover:bg-red-600 hover:text-white transition"><div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center"><i class="fas fa-shield-alt"></i></div><span class="font-bold">Call Police (100)</span></a>
                <a href="tel:108" class="flex items-center gap-4 bg-slate-800 p-4 rounded-xl border border-slate-700 hover:bg-red-600 hover:text-white transition"><div class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center"><i class="fas fa-ambulance"></i></div><span class="font-bold">Ambulance (108)</span></a>
            </div>
        </div>
    </div>

    <audio id="bell" src="sound/rider_sound.mp3"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, updateDoc, doc, onSnapshot, query, where, arrayUnion } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // CONFIG
        const SETUP = { AppName: "VIKA", AppLogo: "V" };
        document.querySelectorAll('.app-name').forEach(el => el.innerText = SETUP.AppName);
        document.querySelectorAll('.app-logo').forEach(el => el.innerText = SETUP.AppLogo);

        const firebaseConfig = { apiKey: "AIzaSyARK1SBVFmjEeqsPdficWzszf6AT1TKZQ8", authDomain: "singleapp-207e3.firebaseapp.com", projectId: "singleapp-207e3", storageBucket: "singleapp-207e3.firebasestorage.app", messagingSenderId: "1026534886749", appId: "1:1026534886749:web:52c3aa09e21a65f9342cb4", measurementId: "G-PPYBRX43TY" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let me = null; let ordersList = []; let watchId = null; let isOnline = false; let previousOrderCount = 0;

        // PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('installBanner').classList.remove('hidden'); });
        document.getElementById('installBtn').onclick = async () => { if (deferredPrompt) { deferredPrompt.prompt(); const { outcome } = await deferredPrompt.userChoice; if (outcome === 'accepted') document.getElementById('installBanner').classList.add('hidden'); deferredPrompt = null; } };

        document.getElementById('loginBtn').onclick = async () => {
            let p = document.getElementById('lPhone').value, pass = document.getElementById('lPass').value;
            const q = query(collection(db, "riders"), where("phone", "==", p), where("pass", "==", pass));
            const snap = await getDocs(q);
            if(!snap.empty) {
                me = { id: snap.docs[0].id, ...snap.docs[0].data() };
                document.getElementById('login').classList.add('hidden'); document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('rName').innerText = me.name.split(' ')[0];
                document.getElementById('pName').innerText = me.name; document.getElementById('pPhone').innerText = me.phone;
                initData();
            } else alert("Invalid Credentials!");
        };

        // Duty Toggle
        document.getElementById('dutyToggle').addEventListener('change', async (e) => {
            isOnline = e.target.checked;
            let statusText = document.getElementById('statusText'), statusDot = document.getElementById('statusDot');
            
            if(isOnline) {
                statusText.innerText = "Online & Tracking"; statusText.classList.replace('text-slate-400', 'text-green-500');
                statusDot.classList.replace('bg-red-500', 'bg-green-500'); statusDot.classList.add('animate-pulse');
                startGPS(); alert("You are ONLINE. GPS Active.");
            } else {
                statusText.innerText = "Offline"; statusText.classList.replace('text-green-500', 'text-slate-400');
                statusDot.classList.replace('bg-green-500', 'bg-red-500'); statusDot.classList.remove('animate-pulse');
                stopGPS();
            }
            if(me) await updateDoc(doc(db, "riders", me.id), { isOnline: isOnline });
            renderDashboard(); // Fix: Update UI instantly
        });

        function startGPS() {
            if (navigator.geolocation && !watchId) {
                watchId = navigator.geolocation.watchPosition(async (pos) => {
                    let activeOrders = ordersList.filter(o => ['Accepted', 'Out for Delivery', 'Arrived'].includes(o.status));
                    activeOrders.forEach(async (o) => { 
                        await updateDoc(doc(db, "orders", o.id), { riderLat: pos.coords.latitude, riderLng: pos.coords.longitude }); 
                    });
                }, (err) => console.log("GPS Error", err), { enableHighAccuracy: true });
            }
        }
        function stopGPS() { if(watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; } }

        function initData() {
            const q = query(collection(db, "orders"), where("riderPhone", "==", me.phone));
            onSnapshot(q, (snap) => {
                ordersList = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                
                let activeOrders = ordersList.filter(o => o.status !== 'Delivered' && o.status !== 'Cancelled');
                if(activeOrders.length > previousOrderCount && isOnline) { 
                    document.getElementById('bell').play().catch(()=>{}); 
                    if(navigator.vibrate) navigator.vibrate([500, 200, 500]); 
                }
                previousOrderCount = activeOrders.length;
                
                renderDashboard(); renderHistory();
            });
        }

        function renderDashboard() {
            let today = new Date().toLocaleDateString();
            let deliveredToday = ordersList.filter(o => o.status === 'Delivered' && new Date(o.timestamp).toLocaleDateString() === today);
            
            document.getElementById('todayEarn').innerText = deliveredToday.length * 30; 
            document.getElementById('todayCount').innerText = deliveredToday.length;
            document.getElementById('codHand').innerText = deliveredToday.reduce((a,b) => a + (parseInt(b.total)||0), 0);
            document.getElementById('pTotal').innerText = ordersList.filter(o => o.status === 'Delivered').length;
            document.getElementById('pEarn').innerText = ordersList.filter(o => o.status === 'Delivered').length * 30;

            if(!isOnline) { 
                document.getElementById('taskList').innerHTML = `<div class="text-center py-20 opacity-30"><i class="fas fa-power-off text-4xl mb-4"></i><p class="font-bold text-sm">You are Offline</p><p class="text-[10px] mt-1">Go Online to receive orders</p></div>`; 
                return; 
            }

            let active = ordersList.filter(o => o.status !== 'Delivered' && o.status !== 'Cancelled').sort((a,b) => b.timestamp - a.timestamp);
            
            if(active.length === 0) { 
                document.getElementById('taskList').innerHTML = `<div class="text-center py-20 opacity-30"><i class="fas fa-check-circle text-4xl mb-4"></i><p>No active orders</p></div>`; 
                return; 
            }

            document.getElementById('taskList').innerHTML = active.map(o => {
                let btn = '';
                if(o.status === 'Preparing') btn = `<button onclick="upd('${o.id}', 'Accepted')" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold mt-3 shadow-lg">ACCEPT JOB</button>`;
                else if(o.status === 'Accepted') btn = `<div class="bg-blue-900/40 text-blue-200 p-3 rounded-xl text-center text-xs mt-3 font-bold border border-blue-500/30">Wait for 'Ready' Status...</div>`;
                else if(o.status === 'Ready for Pickup') btn = `<div class="text-center text-orange-400 font-bold mb-2 animate-pulse text-xs">ORDER READY!</div><button onclick="upd('${o.id}', 'Out for Delivery')" class="w-full bg-orange-600 text-white py-3 rounded-xl font-bold shadow-lg">CONFIRM PICKUP</button>`;
                else if(o.status === 'Out for Delivery') btn = `
                    <div class="flex gap-2 mt-2">
                        <a href="https://www.google.com/maps/search/?api=1&query=${o.customer.lat},${o.customer.lng}" target="_blank" class="flex-1 bg-white text-slate-900 py-3 rounded-xl font-bold text-center text-xs flex items-center justify-center gap-1"><i class="fas fa-map-marker-alt"></i> MAP</a>
                        <a href="tel:${o.customer.phone}" class="flex-1 bg-green-600 py-3 rounded-xl font-bold text-center text-xs flex items-center justify-center gap-1"><i class="fas fa-phone"></i> CALL</a>
                    </div>
                    <button onclick="upd('${o.id}','Arrived')" class="w-full bg-purple-600 text-white py-3 rounded-xl font-bold mt-2 shadow-lg">I HAVE ARRIVED</button>`;
                else if(o.status === 'Arrived') btn = `<button onclick="upd('${o.id}','Delivered')" class="w-full bg-green-500 text-white py-3 rounded-xl font-bold mt-2 shadow-lg">COLLECT CASH & FINISH</button>`;

                return `
                <div class="glass-panel p-5 rounded-[1.5rem] relative mb-4 border border-white/10 shadow-lg slide-up">
                    <div class="flex justify-between items-start mb-3">
                        <span class="status-badge ${['Ready for Pickup','Pending'].includes(o.status)?'st-new':'st-active'}">${o.status}</span>
                        <span class="font-black text-orange-500 text-lg">â‚¹${o.total}</span>
                    </div>
                    
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-slate-800 rounded-lg flex items-center justify-center text-xl border border-slate-700">ðŸ‘¤</div>
                        <div class="flex-1">
                            <h3 class="font-bold text-sm text-white leading-none mb-1">${o.customer.name}</h3>
                            <p class="text-[10px] text-slate-400 truncate">${o.customer.addr}</p>
                        </div>
                    </div>
                    
                    ${btn}
                    
                    <button onclick="showDetails('${o.id}')" class="w-full mt-3 text-center text-[10px] font-bold text-slate-500 hover:text-white transition">VIEW ITEM LIST ></button>
                </div>`;
            }).join('');
        }

        function renderHistory() {
            let hist = ordersList.filter(o => o.status === 'Delivered');
            document.getElementById('histList').innerHTML = hist.map(o => `<div class="glass-panel p-4 rounded-xl flex justify-between items-center opacity-80 hover:opacity-100 transition border border-white/5"><div><p class="text-[10px] text-slate-400 font-bold">${o.date}</p><h4 class="font-bold text-sm text-white">#${o.id.substr(0,5)} â€¢ ${o.customer.name}</h4><span class="text-[10px] bg-green-500/20 text-green-500 px-2 rounded font-bold">Delivered</span></div><div class="text-right"><p class="font-black text-white">â‚¹${o.total}</p></div></div>`).join('') || '<p class="text-center text-slate-500 text-sm mt-10">No history yet.</p>';
        }

        window.showDetails = (oid) => {
            let o = ordersList.find(x => x.id === oid);
            document.getElementById('modalContent').innerHTML = `
                <div class="text-center mb-6">
                    <h1 class="text-4xl font-black text-white">â‚¹${o.total}</h1>
                    <p class="text-xs text-slate-400 font-bold uppercase">Collect Cash</p>
                </div>
                <div class="bg-slate-800 p-4 rounded-xl mb-4 border border-slate-700">
                    <h3 class="font-bold text-slate-300 mb-2 border-b border-slate-700 pb-2 text-xs uppercase">Item List</h3>
                    <div class="space-y-2 text-sm font-mono text-slate-400">
                        ${o.items.map(i => `<div class="flex justify-between"><span>${i.qty} x ${i.name}</span><span>â‚¹${(i.offerPrice||i.price)*i.qty}</span></div>`).join('')}
                    </div>
                </div>
            `;
            document.getElementById('orderModal').classList.remove('hidden');
        }

        window.upd = async (oid, status) => {
            if(status === 'Delivered' && !confirm("Cash Collected: â‚¹" + ordersList.find(o=>o.id==oid).total + "?")) return;
            await updateDoc(doc(db, "orders", oid), { status: status, timeline: arrayUnion({ status: status, msg: 'Rider Update', time: new Date().toLocaleTimeString() }) });
        };

        window.nav = (v) => { 
            ['home','hist','prof'].forEach(x => { document.getElementById('view-'+x).classList.add('hidden'); document.getElementById('btn-'+x).classList.remove('text-white'); document.getElementById('btn-'+x).classList.add('text-slate-500'); }); 
            document.getElementById('view-'+v).classList.remove('hidden'); document.getElementById('btn-'+v).classList.add('text-white'); document.getElementById('btn-'+v).classList.remove('text-slate-500');
        }
    </script>
</body>
</html>